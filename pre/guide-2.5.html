<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <link rel="shortcut icon" href="清华LOGO.png" type="image/x-icon">

  <script>;(function(){var w=parseInt(window.screen.width),s=w/640,u=navigator.userAgent.toLowerCase(),m='<meta name="viewport" content="width=640,';if(/android (\d+\.\d+)/.test(u)){if(parseFloat(RegExp.$1)>2.3)m+='minimum-scale='+s+',maximum-scale='+s+',';}else{m+='user-scalable=no,';}m+='target-densitydpi=device-dpi">';document.write(m);}());</script>
  <link rel="stylesheet" href="guide.css">
  <link rel="stylesheet" href="line_loading.css">

  <title>游戏指导语</title>
</head>
<body>

<div id="main" class="container">

  <div id="header">
    <img src="tsinghua_banner_2.png" width="100%">
    <h3>注意，接下来将开始正式游戏阶段</h3>
    <h2 id="goal">在此阶段，你们二人中最终得分更高者可获得10元额外奖励</h2>
<!--    <p id="goal_hint" style="color:grey; font-weight: bold"> 注：本环节中难度与测试环节相同，实验结束后将根据三个环节的目标实现情况给予1-20元额外奖励</p>-->

    <div id="rule_and_button">
      <div id="formal_rule">
      <p>规则说明：</p>
      <p>1.本环节时间为10分钟，到时间后游戏会自动结束，请不必关心时间问题</p>
      <p>2.每消除一行可获得10分， <b>死亡后分数会扣除20%</b>，死亡后请立即按空格键重新开始</p>
      <p>3.以该环节结束的最后1秒的分数作为该环节最终得分</p>
      </div>

     <button id="btn" disabled="disabled">开始游戏 (5s)</button>
    </div>


    <div id="waiting_page">
      <div id="loading">
        <div id="loading-center">
          <div id="loading-center-absolute">
            <div class="object" id="object_one"></div>
            <div class="object" id="object_two"></div>
            <div class="object" id="object_three"></div>
            <div class="object" id="object_four"></div>
          </div>
        </div>
      </div>

      <h1>队列中</h1>
      <h3>请等待另一位被试进入队列，可能需要10s-1min，进入后将直接开始游戏</h3>
    </div>

  </div>

</div>

<button onclick="clickButton()" id="skip_btn" style="background-color: darkred; display: none; margin-top: 150px"> 开发者选项：跳过排队直接开始 </button>

<script>

  // zyf代码
  // 记录该页面开始的时间
  let timestamp = (new Date()).valueOf();

  function getUrlParameter(name){
    name = name.replace(/[]/,"\[").replace(/[]/,"\[").replace(/[]/,"\\\]");
    var regexS = "[\\?&]"+name+"=([^&#]*)";
    var regex = new RegExp( regexS );
    var results = regex.exec(window.parent.location.href );
    if( results == null ) return ""; else {
      return results[1];
    }
  };

  // 根据c参数和f参数来分配下一个Block的条件
  var condition = getUrlParameter('c')
  let max_score = getUrlParameter('ms')
  let practice_speed = getUrlParameter('v')
  let total_score = getUrlParameter('ts')
  let real_score = getUrlParameter('rs')
  let ext = getUrlParameter('ext')


  // 获取练习页面传递过来的参数：速度和分数,条件
  var link = '../practice/dist/index.html' + '?c=' + condition + '&ext=' + ext
             + '&tchain=' + getUrlParameter('tchain') + '_' + timestamp

  if (getUrlParameter('dev') === '1') {
    link = link + '&dev=1'
    document.getElementById('skip_btn').style.display = 'inline'
  }

  // 开发者选项：跳过排队
  function clickButton() {
    window.location.href=link
  }


  //实现按钮倒计时功能
  let tim=4;
  function aaa(){
    let btn=document.getElementById("btn");
    if(tim<=0)
    {
      btn.textContent="开始游戏" ;
      btn.disabled="";
    }
    else
    {
      btn.textContent="开始游戏"+ "("  +tim+"s)";
      tim--;
    }
  }
  setInterval("aaa()",1000);





</script>

<!--排队功能代码！！-->
<script src=https://cdn.staticfile.org/jquery/2.1.4/jquery.min.js></script>
<script src="https://cdn.staticfile.org/twitter-bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script src="https://cdn.staticfile.org/jquery-easing/1.4.1/jquery.easing.min.js"></script>

<script>
  $(function () {
    var res = null;
    var  uuid = guid();
    console.log(uuid);
    function guid() {
      return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function (c) {
        var r = Math.random() * 16 | 0,
          v = c == 'x' ? r : (r & 0x3 | 0x8);
        return v.toString(16);
      });
    }
    function waitTwoUser(){
      $.ajax({
        url:"http://zyfback.zhiwiki.com/index/index/is_two_user",
        data:{uuid:uuid},
        dataType:'json',
        success:function (data) {
          if(data.status == 3){
            clearInterval(res);
            setTimeout(function () {
              window.location.href=link
            },2000)
          }
          if(data.status == 4){
            setTimeout(function () {
              waitTwoUser()
            },100)

          }
          if(data.status == 5){
            alert('15分钟了,还没人来,排队终止，请刷新页面重新排队');
            setTimeout(function () {
              window.location.reload();
            },1000)
            return;
          }
          console.log(data)
        },
        error:function (err) {
          console.log(err)
        }
      })
    }
    $('#btn').click(function () {

      // 先显示排队页面
      document.getElementById('waiting_page').style.display = 'block'

      // 然后再提交请求
      $.ajax({
        url:"http://zyfback.zhiwiki.com/index/index/goUrl",
        data:{uuid:uuid},
        dataType:'json',
        success:function (data) {
          $('.goUrl').hide();
          if(data.status == 1){
            waitTwoUser()
          }
          if(data.status == 2){
            setTimeout(function () {
              window.location.href=link
            },2000)
          }

          console.log(data)
        },
        error:function (err) {
          console.log(err)
        }
      })
    })



  });
</script>


</body>
</html>

